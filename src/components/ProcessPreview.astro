---
import Container from "./Container.astro";
import Button from "./Button.astro";
import SectionHeader from "./SectionHeader.astro";

const whatsappUrl = import.meta.env.PUBLIC_WHATSAPP_URL ?? "https://wa.me/525574570826";

const steps = [
  {
    number: "01",
    title: "Brief y objetivos",
    description: "Definimos objetivos, alcance y tiempos de tu proyecto corporativo.",
    icon: "brief",
    microcopy: "Brief alineado.",
  },
  {
    number: "02",
    title: "Diseño y propuesta",
    description: "Presentamos propuesta visual, técnica y presupuesto para aprobación.",
    icon: "design",
    microcopy: "Todo claro antes de producir.",
  },
  {
    number: "03",
    title: "Producción y control",
    description: "Fabricamos con control de calidad en cada material y acabado.",
    icon: "production",
    microcopy: "Producción supervisada.",
  },
  {
    number: "04",
    title: "Entrega e instalación",
    description: "Coordinamos entrega e instalación para activar tu marca sin fricción.",
    icon: "install",
    microcopy: "Implementación puntual.",
  },
  {
    number: "05",
    title: "Seguimiento y partnership",
    description: "Damos seguimiento post-entrega para nuevas fases y mantenimiento.",
    icon: "partnership",
    microcopy: "Partner de largo plazo.",
  },
];
---

<section id="proceso" class="process-preview section-bg section-orange-blue relative overflow-hidden" aria-labelledby="proceso-heading">
  <div class="section-glow absolute inset-0 [--section-orange-glow:10%] [--section-green-glow:9%]" aria-hidden="true"></div>
  <div class="section-grid section-grid-soft absolute inset-0" aria-hidden="true"></div>

  <Container class="section-panel relative py-10 md:py-12" as="div">
    <SectionHeader
      id="proceso-heading"
      label="PROCESO"
      titleStart="Proceso "
      accent="claro"
      titleEnd=" de principio a fin"
      subtitle="Metodología para ejecutar branding físico corporativo con control de calidad, tiempos definidos y seguimiento."
    />

    <div class="relative mt-10 md:mt-12">
      <div class="mb-3 flex items-center justify-between md:hidden" aria-hidden="true">
        <p class="text-xs tabular-nums text-text-muted">
          <span data-process-current class="font-semibold text-text-primary">01</span>
          <span class="ml-1">/ {String(steps.length).padStart(2, "0")}</span>
        </p>
        <p class="inline-flex items-center gap-1 text-[11px] font-medium text-text-muted">
          <span>Desliza</span>
          <span aria-hidden="true">→</span>
        </p>
      </div>
      <span class="sr-only" data-process-live aria-live="polite" aria-atomic="true">Paso 1 de {steps.length}</span>

      <div
        class="pointer-events-none absolute left-8 right-8 top-7 hidden h-px bg-gradient-to-r from-brand-orange/25 via-border to-brand-blue/20 lg:block"
        aria-hidden="true"
      ></div>

      <div class="mb-4 hidden justify-end gap-2 md:flex lg:hidden">
        <button
          type="button"
          data-process-prev
          class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-border bg-surface text-text-secondary shadow-sm transition-colors hover:bg-surface-soft hover:text-text-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2"
          aria-label="Desplazar al paso anterior"
        >
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m15 19-7-7 7-7" />
          </svg>
        </button>
        <button
          type="button"
          data-process-next
          class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-border bg-surface text-text-secondary shadow-sm transition-colors hover:bg-surface-soft hover:text-text-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2"
          aria-label="Desplazar al siguiente paso"
        >
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m9 5 7 7-7 7" />
          </svg>
        </button>
      </div>

      <div
        data-process-track
        class="process-track flex snap-x snap-mandatory gap-4 overflow-x-auto px-1 pb-2 scroll-smooth md:gap-5 lg:grid lg:grid-cols-5 lg:gap-6 lg:overflow-visible lg:px-0 lg:pb-0"
        role="list"
        aria-label="Etapas del proceso de trabajo"
      >
        {steps.map((step, index) => (
          <article
            data-process-card
            data-step-index={index}
            role="listitem"
            tabindex="0"
            aria-label={`Paso ${step.number}: ${step.title}`}
            class="ui-interactive group relative z-10 flex h-full w-[88vw] shrink-0 snap-center flex-col rounded-2xl border border-border bg-surface p-5 shadow-sm hover:border-brand-blue/25 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2 sm:w-[72vw] sm:p-6 md:w-[calc(50%-0.625rem)] lg:w-auto lg:min-w-0"
          >
            <div
              class="pointer-events-none absolute inset-0 rounded-2xl opacity-0 transition-opacity duration-300 group-hover:opacity-100 group-focus-visible:opacity-100"
              aria-hidden="true"
            >
              <div class="h-full w-full rounded-2xl bg-[linear-gradient(135deg,color-mix(in_srgb,var(--brand-orange)_9%,transparent),transparent_42%,color-mix(in_srgb,var(--brand-blue)_7%,transparent))]"></div>
            </div>

            <div class="relative flex items-start justify-between gap-4">
              <span class="inline-flex items-center rounded-full border border-border bg-surface-soft px-2.5 py-1 text-[11px] font-semibold tracking-wide text-text-secondary">
                {step.number}
              </span>

              <span class="inline-flex h-11 w-11 items-center justify-center rounded-xl border border-brand-blue/15 bg-brand-blue/5 text-brand-blue ring-4 ring-brand-blue/5">
                {step.icon === "brief" && (
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" stroke-width="1.8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                    <rect x="3" y="7" width="18" height="14" rx="2.5" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12h18" />
                  </svg>
                )}
                {step.icon === "design" && (
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" stroke-width="1.8">
                    <rect x="4" y="4" width="16" height="16" rx="2.5" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 16 16 8" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="m9 8 7 7" />
                  </svg>
                )}
                {step.icon === "production" && (
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" stroke-width="1.8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M7.5 8.5h9M7.5 15.5h9" />
                    <circle cx="5" cy="8.5" r="1" fill="currentColor" stroke="none" />
                    <circle cx="5" cy="15.5" r="1" fill="currentColor" stroke="none" />
                  </svg>
                )}
                {step.icon === "install" && (
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" stroke-width="1.8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 8h18M7 8V6.5A1.5 1.5 0 0 1 8.5 5h7A1.5 1.5 0 0 1 17 6.5V8" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 8v8.5A2.5 2.5 0 0 0 7.5 19h9A2.5 2.5 0 0 0 19 16.5V8" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 12h4" />
                  </svg>
                )}
                {step.icon === "partnership" && (
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" stroke-width="1.8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 13.5 10.2 16.5a2 2 0 0 0 2.7 0L17 12.7a2 2 0 0 0 0-2.9l-2.2-2a2 2 0 0 0-2.8 0l-1.1 1.1-1-1a2 2 0 0 0-2.8 0l-2.1 2a2 2 0 0 0 0 2.8Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 19h14" />
                  </svg>
                )}
              </span>
            </div>

            <h3 class="relative mt-5 text-lg font-semibold leading-snug text-text-primary">{step.title}</h3>
            <p class="relative mt-2 text-sm leading-relaxed text-text-secondary">{step.description}</p>
            <p class="relative mt-4 text-sm text-text-secondary">{step.microcopy}</p>
          </article>
        ))}
      </div>

      <div class="mt-5 flex items-center justify-center gap-2 md:hidden" aria-hidden="true">
        {steps.map((_, index) => (
          <span
            data-process-dot
            data-dot-index={index}
            class={`h-1.5 rounded-full bg-border transition-all duration-200 ${index === 0 ? "w-5 !bg-brand-orange" : "w-1.5"}`}
          ></span>
        ))}
      </div>
    </div>

    <div class="mt-12 flex flex-col items-stretch justify-center gap-3 sm:flex-row sm:items-center sm:gap-4">
      <Button href="/#contacto" variant="primary" size="md" class="min-h-11 w-full !rounded-xl sm:w-auto" ariaLabel="Cotizar proyecto con Enfoque">
        Cotizar proyecto
      </Button>
      <a
        href={whatsappUrl}
        target="_blank"
        rel="noopener noreferrer"
        aria-label="Escribir por WhatsApp para cotizar proyecto"
        class="ui-interactive inline-flex min-h-11 w-full items-center justify-center gap-2 rounded-xl border-2 border-accent-green bg-accent-green px-6 py-3 text-base font-semibold text-white hover:border-[#00853a] hover:bg-[#00853a] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2 sm:w-auto"
      >
        <svg viewBox="0 0 24 24" class="h-4 w-4" fill="currentColor" aria-hidden="true">
          <path d="M12 2a10 10 0 0 0-8.66 15L2 22l5.14-1.33A10 10 0 1 0 12 2Zm5.68 14.2c-.24.66-1.38 1.23-1.9 1.3-.49.06-1.11.09-1.79-.13-.41-.13-.93-.3-1.6-.58-2.81-1.2-4.64-4.1-4.78-4.3-.14-.2-1.14-1.52-1.14-2.9 0-1.38.72-2.05.98-2.33.26-.29.56-.36.75-.36.19 0 .38 0 .54.01.17.01.4-.06.63.49.24.57.82 1.96.89 2.1.07.14.12.31.02.5-.1.19-.15.31-.3.48-.14.17-.3.38-.43.5-.14.14-.28.29-.12.57.17.28.74 1.22 1.58 1.98 1.08.96 1.99 1.25 2.27 1.39.28.14.44.12.6-.07.17-.19.72-.84.91-1.12.19-.29.38-.24.63-.14.26.09 1.63.77 1.91.92.28.14.47.21.54.33.07.12.07.69-.17 1.35Z" />
        </svg>
        WhatsApp
      </a>
    </div>
  </Container>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const track = document.querySelector("[data-process-track]");
    if (!track) return;

    const cards = Array.from(track.querySelectorAll("[data-process-card]"));
    const dots = Array.from(document.querySelectorAll("[data-process-dot]"));
    const currentIndicator = document.querySelector("[data-process-current]");
    const liveRegion = document.querySelector("[data-process-live]");
    const prevButton = document.querySelector("[data-process-prev]");
    const nextButton = document.querySelector("[data-process-next]");

    if (!cards.length || !dots.length) return;

    const getActiveIndex = () => {
      const trackCenter = track.scrollLeft + track.clientWidth / 2;
      let active = 0;
      let minDistance = Number.POSITIVE_INFINITY;

      cards.forEach((card, index) => {
        const cardCenter = card.offsetLeft + card.clientWidth / 2;
        const distance = Math.abs(cardCenter - trackCenter);

        if (distance < minDistance) {
          minDistance = distance;
          active = index;
        }
      });

      return active;
    };

    const setActiveDot = (activeIndex) => {
      dots.forEach((dot, index) => {
        dot.classList.toggle("w-5", index === activeIndex);
        dot.classList.toggle("!bg-brand-orange", index === activeIndex);
        dot.classList.toggle("w-1.5", index !== activeIndex);
      });

      if (currentIndicator) {
        currentIndicator.textContent = String(activeIndex + 1).padStart(2, "0");
      }

      if (liveRegion) {
        liveRegion.textContent = `Paso ${activeIndex + 1} de ${cards.length}`;
      }
    };

    const scrollToIndex = (index) => {
      const safeIndex = Math.max(0, Math.min(index, cards.length - 1));
      cards[safeIndex]?.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
    };

    let scrollTicking = false;
    track.addEventListener(
      "scroll",
      () => {
        if (scrollTicking) return;
        scrollTicking = true;

        window.requestAnimationFrame(() => {
          setActiveDot(getActiveIndex());
          scrollTicking = false;
        });
      },
      { passive: true }
    );

    prevButton?.addEventListener("click", () => {
      scrollToIndex(getActiveIndex() - 1);
    });

    nextButton?.addEventListener("click", () => {
      scrollToIndex(getActiveIndex() + 1);
    });

    window.addEventListener("resize", () => {
      setActiveDot(getActiveIndex());
    });

    setActiveDot(getActiveIndex());
  });
</script>

<style>
  .process-track {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .process-track::-webkit-scrollbar {
    display: none;
  }

  @media (min-width: 1024px) {
    .process-track {
      align-items: stretch;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .process-track {
      scroll-behavior: auto;
    }
  }
</style>
