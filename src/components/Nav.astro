---
import Container from "./Container.astro";
import Button from "./Button.astro";
import logoSvg from "../assets/enfoque-ppp.svg";
import logoPng from "../assets/enfoque-ppp.png";

const links = [
  { href: "/#servicios", label: "Servicios" },
  { href: "/#portafolio", label: "Portafolio" },
  { href: "/#proceso", label: "Proceso" },
  { href: "/#nosotros", label: "Nosotros" },
  { href: "/#contacto", label: "Contacto" },
];

const whatsappUrl = import.meta.env.PUBLIC_WHATSAPP_URL ?? "https://wa.me/521XXXXXXXXXX";
const logoSrc = logoSvg ?? logoPng;
---

<header
  id="nav-header"
  class="nav-header sticky top-0 z-50 border-b border-border bg-surface/80 backdrop-blur-md transition-all duration-200"
>
  <nav class="relative py-3" aria-label="Navegación principal">
    <Container as="div" class="flex flex-wrap items-center justify-between gap-4">
      <!-- Brand lockup -->
      <a
        href="/"
        aria-label="Ir a inicio"
        class="flex items-center gap-3 min-w-0 max-w-[200px] rounded focus:outline-none focus:ring-2 focus:ring-brand-orange focus:ring-offset-2 transition-colors sm:max-w-[260px]"
      >
        <span class="flex items-center justify-center rounded-xl border border-border bg-surface p-1.5 shadow-sm">
          <img
            src={logoSrc}
            alt="Enfoque en Medios Publicitarios"
            class="h-7 w-7 object-contain sm:h-8 sm:w-8"
          />
        </span>
        <span class="flex min-w-0 flex-col leading-tight">
          <span
            class="truncate text-[13px] font-semibold leading-tight text-text-primary transition-colors hover:text-brand-blue md:text-sm"
            title="Enfoque en Medios Publicitarios"
          >
            Enfoque en Medios Publicitarios
          </span>
          <span class="hidden truncate text-[11px] leading-tight text-text-muted sm:block">
            Publicidad impresa • Producción • Instalación
          </span>
        </span>
      </a>

      <!-- Desktop: links + CTAs -->
      <div class="hidden items-center gap-6 lg:flex">
        <div class="flex items-center gap-4">
          {links.map((l) => (
            <a
              href={l.href}
              data-nav-link
              class="nav-link relative rounded text-sm font-semibold text-text-muted transition-colors focus:outline-none focus:ring-2 focus:ring-brand-orange focus:ring-offset-2"
            >
              <span class="relative z-10">{l.label}</span>
            </a>
          ))}
        </div>
        <div class="ml-2 flex items-center gap-2">
          <Button href="/#contacto" variant="primary" size="sm">
            Cotizar proyecto
          </Button>
          <a
            href={whatsappUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center justify-center rounded-full border-2 border-brand-blue px-4 py-2 text-sm font-semibold text-brand-blue transition-all hover:bg-brand-blue/10 hover:text-brand-blue focus:outline-none focus:ring-2 focus:ring-brand-orange focus:ring-offset-2"
            aria-label="Hablar por WhatsApp"
          >
            WhatsApp
          </a>
        </div>
      </div>

      <!-- Mobile: hamburger -->
      <div class="flex items-center gap-2 lg:hidden">
        <Button href="/#contacto" variant="primary" size="sm">
          Cotizar
        </Button>
        <button
          id="nav-menu-button"
          type="button"
          class="flex h-10 w-10 items-center justify-center rounded-full border border-border text-text-primary transition-colors hover:bg-surface-soft focus:outline-none focus:ring-2 focus:ring-brand-orange focus:ring-offset-2"
          aria-expanded="false"
          aria-controls="nav-menu-panel"
          aria-label="Abrir menú"
        >
          <svg id="nav-icon-open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
          <svg id="nav-icon-close" class="hidden h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </Container>

    <!-- Mobile menu panel -->
    <div
      id="nav-menu-panel"
      class="nav-menu-panel absolute left-0 right-0 top-full z-40 border-t border-border bg-surface lg:hidden transition-[opacity,transform] duration-200 ease-out opacity-0 -translate-y-3 pointer-events-none"
      role="dialog"
      aria-label="Menú de navegación"
      aria-hidden="true"
    >
      <div class="mx-auto max-w-6xl px-4 py-4 sm:px-6">
        <ul class="flex flex-col gap-1" role="list">
          {links.map((l) => (
            <li>
              <a
                href={l.href}
                data-nav-link
                class="nav-mobile-link block rounded-xl px-4 py-3 text-text-secondary transition-colors hover:bg-surface-soft hover:text-text-primary focus:outline-none focus:ring-2 focus:ring-brand-orange focus:ring-inset"
              >
                {l.label}
              </a>
            </li>
          ))}
        </ul>
        <div class="mt-4 flex flex-col gap-2 border-t border-border pt-4">
          <Button href="/#contacto" variant="primary" size="md" class="w-full">
            Cotizar proyecto
          </Button>
          <a
            href={whatsappUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex w-full items-center justify-center rounded-xl border-2 border-brand-blue px-6 py-3 text-base font-semibold text-brand-blue transition-colors hover:bg-brand-blue/10 focus:outline-none focus:ring-2 focus:ring-brand-orange focus:ring-offset-2"
            aria-label="Hablar por WhatsApp"
          >
            WhatsApp
          </a>
        </div>
      </div>
    </div>
  </nav>
</header>

<style>
  .nav-header[data-scrolled="true"] {
    background-color: color-mix(in srgb, var(--surface) 96%, transparent);
    box-shadow: 0 8px 24px rgb(0 0 0 / 0.08);
  }

  .nav-link {
    padding: 0.25rem 0.5rem;
  }

  .nav-link::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: -0.35rem;
    height: 2px;
    width: 100%;
    transform: scaleX(0);
    transform-origin: left;
    background: linear-gradient(90deg, var(--brand-orange), color-mix(in srgb, var(--brand-orange) 40%, var(--brand-blue)));
    transition: transform 220ms ease;
  }

  .nav-link[data-active="true"],
  .nav-link:hover {
    color: var(--text-primary);
  }

  .nav-link[data-active="true"]::after,
  .nav-link:hover::after {
    transform: scaleX(1);
  }

  .nav-menu-panel.nav-menu-open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .nav-menu-panel.nav-menu-open[aria-hidden="false"] {
    visibility: visible;
  }
</style>

<script>
  function initNav() {
    const header = document.getElementById("nav-header");
    const menuButton = document.getElementById("nav-menu-button");
    const menuPanel = document.getElementById("nav-menu-panel");
    const iconOpen = document.getElementById("nav-icon-open");
    const iconClose = document.getElementById("nav-icon-close");
    const navLinks = document.querySelectorAll("[data-nav-link]");

    if (!header || !menuButton || !menuPanel || !iconOpen || !iconClose) return;

    const sectionIds = ["servicios", "portafolio", "proceso", "nosotros", "contacto"];

    function setActiveBySectionId(id) {
      const targetHref = id ? `/#${id}` : null;
      navLinks.forEach((link) => {
        const href = link.getAttribute("href");
        link.setAttribute("data-active", href && targetHref && href === targetHref ? "true" : "false");
      });
    }

    function setActiveByHash() {
      const hash = window.location.hash.slice(1) || "";
      setActiveBySectionId(hash || null);
    }

    // --- Scrolled state ---
    let scrollTicking = false;
    function updateScrolled() {
      const isScrolled = window.scrollY > 10;
      header.setAttribute("data-scrolled", isScrolled ? "true" : "false");
    }
    function onScroll() {
      if (!scrollTicking) {
        requestAnimationFrame(() => {
          updateScrolled();
          scrollTicking = false;
        });
        scrollTicking = true;
      }
    }
    updateScrolled();
    window.addEventListener("scroll", onScroll, { passive: true });

    // --- Active links (hash + scroll-spy) ---
    setActiveByHash();
    window.addEventListener("hashchange", setActiveByHash);

    try {
      const observer = new IntersectionObserver(
        (entries) => {
          const visible = entries.filter((entry) => entry.isIntersecting && entry.target.id);
          if (visible.length === 0) return;
          const best = visible.reduce((a, b) => (a.intersectionRatio >= b.intersectionRatio ? a : b));
          setActiveBySectionId(best.target.id);
        },
        { root: null, rootMargin: "0px 0px -45% 0px", threshold: [0.2, 0.4, 0.6, 0.8] }
      );
      sectionIds.forEach((id) => {
        const el = document.getElementById(id);
        if (el) observer.observe(el);
      });
    } catch (_) {}

    // --- Mobile menu ---
    function openMenu() {
      menuPanel.classList.add("nav-menu-open");
      menuPanel.setAttribute("aria-hidden", "false");
      menuButton.setAttribute("aria-expanded", "true");
      menuButton.setAttribute("aria-label", "Cerrar menú");
      iconOpen.classList.add("hidden");
      iconClose.classList.remove("hidden");
    }

    function closeMenu() {
      menuPanel.classList.remove("nav-menu-open");
      menuPanel.setAttribute("aria-hidden", "true");
      menuButton.setAttribute("aria-expanded", "false");
      menuButton.setAttribute("aria-label", "Abrir menú");
      iconOpen.classList.remove("hidden");
      iconClose.classList.add("hidden");
    }

    menuButton.addEventListener("click", () => {
      const expanded = menuButton.getAttribute("aria-expanded") === "true";
      if (expanded) closeMenu();
      else openMenu();
    });

    menuPanel.querySelectorAll(".nav-mobile-link").forEach((link) => {
      link.addEventListener("click", closeMenu);
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") closeMenu();
    });

    document.addEventListener("click", (event) => {
      const expanded = menuButton.getAttribute("aria-expanded") === "true";
      if (!expanded) return;
      const target = event.target;
      if (target && !menuPanel.contains(target) && target !== menuButton && !menuButton.contains(target)) {
        closeMenu();
      }
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initNav);
  } else {
    initNav();
  }
</script>
