---
import Container from "./Container.astro";

const links = [
  { href: "/#portafolio", label: "Portafolio", section: "portafolio" },
  { href: "/#proceso", label: "Proceso", section: "proceso" },
  { href: "/#nosotros", label: "Nosotros", section: "nosotros" },
  { href: "/#contacto", label: "Contacto", section: "contacto" },
];

const servicesLinks = [
  { label: "Branding físico para empresas", href: "/servicios/branding-fisico" },
  { label: "Expo / stands corporativos", href: "/servicios/expo-stands" },
  { label: "Papelería corporativa premium", href: "/servicios/papeleria-corporativa" },
  { label: "Grabado láser y personalización", href: "/servicios/grabado-laser" },
  { label: "Impresión textil profesional", href: "/servicios/impresion-textil" },
  { label: "Diseño gráfico aplicado a producción", href: "/servicios/diseno-grafico" },
];

const whatsappUrl = import.meta.env.PUBLIC_WHATSAPP_URL ?? "https://wa.me/525574570826";
const isServicesPath = Astro.url.pathname.startsWith("/servicios");
---

<!-- Sticky headers break if an ancestor uses overflow/transform/filter; keep those styles on page content wrappers, not around this header. -->
<header
  id="nav-header"
  class="navbar border-b border-border/60 bg-white/80 transition-all duration-200"
>
  <nav class="relative py-3" aria-label="Navegación principal">
    <Container as="div" class="relative z-[60] flex items-center justify-between gap-4">
      <a
        href="/"
        aria-label="Ir a inicio"
        class="rounded-lg focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2"
      >
        <img
          src="/images/nav/enfoque-ppp.png"
          alt="Enfoque en Medios Publicitarios"
          class="h-10 w-auto object-contain sm:h-11 md:h-12"
          loading="eager"
          decoding="async"
        />
      </a>

      <div class="hidden items-center gap-6 lg:flex">
        <div class="flex items-center gap-1.5">
          <div class="relative" data-services-item>
            <button
              type="button"
              id="nav-services-button"
              class="nav-link ui-interactive relative inline-flex items-center gap-1.5 rounded-full px-3 py-2 text-sm font-semibold text-text-secondary hover:bg-surface-soft hover:text-text-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2"
              data-nav-link
              data-nav-section="servicios"
              data-active={isServicesPath ? "true" : "false"}
              aria-expanded="false"
              aria-controls="nav-services-menu"
              aria-haspopup="true"
            >
              <span class="relative z-10">Servicios</span>
              <svg
                id="nav-services-chevron"
                class="relative z-10 h-4 w-4 transition-transform duration-200"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                aria-hidden="true"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m6 9 6 6 6-6" />
              </svg>
            </button>

            <div
              id="nav-services-menu"
              class="services-menu invisible absolute left-0 top-full z-50 mt-2 w-[21rem] rounded-2xl border border-border/90 bg-surface/98 p-3 opacity-0 shadow-[0_18px_40px_-28px_rgba(15,23,42,0.45)] ring-1 ring-black/5 transition duration-200 ease-out"
              role="menu"
              aria-label="Submenú de servicios"
              aria-hidden="true"
            >
              <div class="space-y-1">
                {servicesLinks.map((service) => (
                  <a
                    href={service.href}
                    role="menuitem"
                    class="ui-interactive block rounded-xl px-4 py-2 text-sm font-medium text-text-secondary hover:bg-surface-soft hover:text-text-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-inset"
                    data-services-link
                  >
                    {service.label}
                  </a>
                ))}
              </div>

              <div class="mt-2 border-t border-border pt-2">
                <a
                  href="/servicios"
                  role="menuitem"
                  class="ui-interactive block rounded-xl px-4 py-2 text-sm font-semibold text-text-secondary hover:bg-surface-soft hover:text-brand-blue focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-inset"
                  data-services-link
                >
                  Ver todos los servicios →
                </a>
              </div>
            </div>
          </div>

          {links.map((l) => (
            <a
              href={l.href}
              data-nav-link
              data-nav-section={l.section}
              class="nav-link ui-interactive relative rounded-full px-3 py-2 text-sm font-semibold text-text-secondary hover:bg-surface-soft hover:text-text-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2"
            >
              <span class="relative z-10">{l.label}</span>
            </a>
          ))}
        </div>

        <a
          href={whatsappUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="ui-interactive inline-flex min-h-11 items-center justify-center rounded-full bg-green-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2"
          aria-label="Cotizar por WhatsApp"
        >
          <svg class="mr-2 h-5 w-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z" />
            <path d="M12.051 21.785h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884a9.86 9.86 0 0 1 9.881 9.892c-.003 5.45-4.437 9.884-9.885 9.884z" />
          </svg>
          Cotizar por WhatsApp
        </a>
      </div>

      <div class="flex items-center lg:hidden">
        <button
          id="nav-menu-button"
          type="button"
          class="ui-interactive flex h-11 w-11 items-center justify-center rounded-full border border-border text-text-primary hover:bg-surface-soft focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2"
          aria-expanded="false"
          aria-controls="nav-menu-panel"
          aria-label="Abrir menú"
          data-menu-toggle
        >
          <svg id="nav-icon-open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
          <svg id="nav-icon-close" class="hidden h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </Container>

    <div
      id="nav-menu-overlay"
      class="nav-menu-overlay fixed inset-0 z-[1000] bg-slate-950/62 opacity-0 pointer-events-none backdrop-blur-sm transition-opacity duration-200 md:hidden"
      aria-hidden="true"
    ></div>

    <div
      id="nav-menu-panel"
      class="nav-menu-panel fixed inset-x-4 z-[1010] flex max-h-[calc(100dvh-var(--nav-h,4.5rem)-1rem-env(safe-area-inset-bottom))] flex-col gap-4 overflow-y-auto rounded-2xl border border-border/80 bg-white p-4 shadow-[0_30px_65px_-32px_rgba(15,23,42,0.55)] opacity-0 pointer-events-none transition-all duration-200 md:inset-0 md:max-h-none md:rounded-none md:border-0 md:bg-white/95 md:p-6 md:pt-24 md:shadow-none lg:hidden"
      role="dialog"
      aria-modal="true"
      aria-label="Menú de navegación"
      aria-hidden="true"
    >
      <div class="mx-auto w-full max-w-xl">
        <ul class="flex flex-col gap-1" role="list">
          <li>
            <button
              type="button"
              class="nav-mobile-link flex min-h-11 w-full items-center justify-between rounded-xl px-4 py-3 text-left text-text-secondary transition-colors hover:bg-surface-soft hover:text-text-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-inset"
              id="mobile-services-toggle"
              data-mobile-dropdown-toggle
              data-nav-link
              data-nav-section="servicios"
              data-active={isServicesPath ? "true" : "false"}
              aria-expanded="false"
              aria-controls="mobile-services-list"
            >
              <span class="font-semibold">Servicios</span>
              <svg
                class="h-4 w-4 transition-transform duration-200"
                data-mobile-services-chevron
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                aria-hidden="true"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m6 9 6 6 6-6" />
              </svg>
            </button>

            <div id="mobile-services-list" class="hidden space-y-1 px-2 pb-2" aria-hidden="true">
              {servicesLinks.map((service) => (
                <a
                  href={service.href}
                  class="ui-interactive block min-h-11 rounded-xl px-4 py-2.5 text-sm text-text-secondary hover:bg-surface-soft hover:text-text-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-inset"
                  data-mobile-close-link
                  data-mobile-service-link
                >
                  {service.label}
                </a>
              ))}
              <a
                href="/servicios"
                class="ui-interactive mt-1 block min-h-11 rounded-xl border-t border-border px-4 py-2.5 text-sm font-semibold text-text-secondary hover:bg-surface-soft hover:text-brand-blue focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-inset"
                data-mobile-close-link
                data-mobile-service-link
              >
                Ver todos los servicios →
              </a>
            </div>
          </li>

          {links.map((l) => (
            <li>
              <a
                href={l.href}
                data-nav-link
                data-nav-section={l.section}
                data-mobile-close-link
                class="nav-mobile-link block min-h-11 rounded-xl px-4 py-3 text-text-secondary transition-colors hover:bg-surface-soft hover:text-text-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-inset"
              >
                {l.label}
              </a>
            </li>
          ))}
        </ul>

        <div class="mt-5 border-t border-border pt-5">
          <a
          href={whatsappUrl}
          target="_blank"
          rel="noopener noreferrer"
          data-mobile-close-link
          class="ui-interactive inline-flex min-h-11 w-full items-center justify-center rounded-xl bg-green-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-green-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2"
          aria-label="Cotizar por WhatsApp"
        >
            <svg class="mr-2 h-5 w-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z" />
              <path d="M12.051 21.785h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884a9.86 9.86 0 0 1 9.881 9.892c-.003 5.45-4.437 9.884-9.885 9.884z" />
            </svg>
            Cotizar por WhatsApp
          </a>
        </div>
      </div>
    </div>
  </nav>
</header>

<style>
  .navbar {
    position: sticky;
    top: 0;
    z-index: 999;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 10px 30px -24px rgb(0 0 0 / 0.2);
  }

  .nav-link::after {
    content: "";
    position: absolute;
    left: 0.62rem;
    right: 0.62rem;
    bottom: 0.48rem;
    height: 0.35rem;
    border-radius: 999px;
    z-index: 0;
    opacity: 0;
    transform: scaleX(0.84);
    background: color-mix(in srgb, var(--brand-orange) 45%, transparent);
    transition: opacity 200ms ease, transform 200ms ease;
  }

  .nav-link[data-active="true"] {
    color: var(--text-primary);
    background: color-mix(in srgb, var(--surface-soft) 72%, transparent);
  }

  .nav-link[data-active="true"]::after,
  .nav-link:hover::after {
    opacity: 1;
    transform: scaleX(1);
  }

  .services-menu[data-open="true"] {
    visibility: visible;
    opacity: 1;
    transform: translateY(0);
  }

  .services-menu {
    transform: translateY(0.5rem);
  }

  .nav-menu-overlay.nav-menu-open {
    opacity: 1;
    pointer-events: auto;
  }

  .nav-menu-panel.nav-menu-open {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  .nav-menu-panel {
    transform: translateY(0.45rem);
  }

  .nav-mobile-link[data-active="true"] {
    color: var(--text-primary);
    background: color-mix(in srgb, var(--brand-orange) 14%, var(--surface));
  }

  @media (max-width: 767px) {
    .navbar {
      background: rgb(255 255 255 / 0.94);
      border-bottom-color: color-mix(in srgb, var(--border) 78%, white 22%);
      box-shadow: 0 12px 26px -20px rgb(15 23 42 / 0.32);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .navbar > nav {
      padding-top: calc(env(safe-area-inset-top) + 0.55rem);
      padding-bottom: 0.65rem;
    }

    .nav-menu-panel {
      left: max(0.75rem, env(safe-area-inset-left));
      right: max(0.75rem, env(safe-area-inset-right));
      top: calc(var(--nav-h, 4.5rem) + 0.5rem);
      padding-bottom: calc(1rem + env(safe-area-inset-bottom));
      border-color: color-mix(in srgb, var(--border) 72%, white 28%);
      box-shadow: 0 26px 58px -28px rgb(15 23 42 / 0.52);
      background: var(--surface);
    }
  }

  :global(body.nav-no-scroll) {
    overflow: hidden;
    touch-action: none;
    overscroll-behavior: none;
  }
</style>

<script>
  function initNav() {
    const header = document.getElementById("nav-header");
    const menuButton = document.getElementById("nav-menu-button");
    const menuOverlay = document.getElementById("nav-menu-overlay");
    const menuPanel = document.getElementById("nav-menu-panel");
    const iconOpen = document.getElementById("nav-icon-open");
    const iconClose = document.getElementById("nav-icon-close");
    const navLinks = document.querySelectorAll("[data-nav-link]");

    const servicesItem = document.querySelector("[data-services-item]");
    const servicesButton = document.getElementById("nav-services-button");
    const servicesMenu = document.getElementById("nav-services-menu");
    const servicesChevron = document.getElementById("nav-services-chevron");

    const mobileServicesToggle = document.getElementById("mobile-services-toggle");
    const mobileServicesList = document.getElementById("mobile-services-list");
    const mobileServicesChevron = document.querySelector("[data-mobile-services-chevron]");
    const mobileCloseLinks = menuPanel.querySelectorAll("[data-mobile-close-link]");

    if (!header || !menuButton || !menuPanel || !iconOpen || !iconClose) return;

    const isServicesPage = window.location.pathname.startsWith("/servicios");
    const isHomePage = window.location.pathname === "/";
    const sectionIds = ["servicios", "portafolio", "proceso", "nosotros", "contacto"];
    const mobileViewportQuery = window.matchMedia("(max-width: 767px)");
    let previouslyFocusedElement = null;

    function syncNavHeightVar() {
      const navHeight = Math.ceil(header.getBoundingClientRect().height || 0);
      if (navHeight > 0) {
        document.documentElement.style.setProperty("--nav-h", `${navHeight}px`);
      }
    }

    function setActiveBySectionId(id) {
      const normalizedId = id && sectionIds.includes(id) ? id : null;
      navLinks.forEach((link) => {
        const section = link.getAttribute("data-nav-section");

        if (section === "servicios") {
          const active = isServicesPage || normalizedId === "servicios";
          link.setAttribute("data-active", active ? "true" : "false");
          return;
        }

        const active = !isServicesPage && normalizedId === section;
        link.setAttribute("data-active", active ? "true" : "false");
      });
    }

    function setActiveByHash() {
      const hash = window.location.hash.slice(1) || "";
      setActiveBySectionId(hash || null);
    }

    function setDesktopServicesOpen(isOpen) {
      if (!servicesMenu || !servicesButton) return;
      servicesMenu.setAttribute("data-open", isOpen ? "true" : "false");
      servicesMenu.setAttribute("aria-hidden", isOpen ? "false" : "true");
      servicesButton.setAttribute("aria-expanded", isOpen ? "true" : "false");
      servicesChevron?.classList.toggle("rotate-180", isOpen);
    }

    function setMobileServicesOpen(isOpen) {
      if (!mobileServicesToggle || !mobileServicesList) return;
      mobileServicesToggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
      mobileServicesList.classList.toggle("hidden", !isOpen);
      mobileServicesList.setAttribute("aria-hidden", isOpen ? "false" : "true");
      mobileServicesChevron?.classList.toggle("rotate-180", isOpen);
    }

    function isMenuOpen() {
      return menuButton.getAttribute("aria-expanded") === "true";
    }

    function setBodyScrollLocked(isLocked) {
      if (isLocked && !mobileViewportQuery.matches) return;
      document.body.classList.toggle("nav-no-scroll", isLocked);
    }

    syncNavHeightVar();
    if ("ResizeObserver" in window) {
      const navResizeObserver = new ResizeObserver(() => syncNavHeightVar());
      navResizeObserver.observe(header);
    } else {
      window.addEventListener("resize", syncNavHeightVar, { passive: true });
    }

    setActiveByHash();
    window.addEventListener("hashchange", setActiveByHash);

    navLinks.forEach((link) => {
      link.addEventListener("click", (event) => {
        const href = link.getAttribute("href");
        if (!href) return;

        const menuOpen = menuButton.getAttribute("aria-expanded") === "true";
        if (menuOpen && link.classList.contains("nav-mobile-link")) {
          closeMenu();
        }

        if (!isHomePage || !href.startsWith("/#")) return;

        const targetId = href.slice(2);
        const target = targetId ? document.getElementById(targetId) : null;
        if (!target) return;

        event.preventDefault();
        target.scrollIntoView({ behavior: "smooth", block: "start" });
        setActiveBySectionId(targetId);
        history.replaceState(null, "", `/#${targetId}`);
      });
    });

    function openMenu() {
      previouslyFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;
      menuPanel.classList.add("nav-menu-open");
      menuPanel.setAttribute("aria-hidden", "false");
      menuOverlay?.classList.add("nav-menu-open");
      menuOverlay?.setAttribute("aria-hidden", "false");
      menuButton.setAttribute("aria-expanded", "true");
      menuButton.setAttribute("aria-label", "Cerrar menú");
      iconOpen.classList.add("hidden");
      iconClose.classList.remove("hidden");
      setBodyScrollLocked(true);
      window.requestAnimationFrame(() => menuButton.focus());
    }

    function closeMenu({ restoreFocus = false } = {}) {
      menuPanel.classList.remove("nav-menu-open");
      menuPanel.setAttribute("aria-hidden", "true");
      menuOverlay?.classList.remove("nav-menu-open");
      menuOverlay?.setAttribute("aria-hidden", "true");
      menuButton.setAttribute("aria-expanded", "false");
      menuButton.setAttribute("aria-label", "Abrir menú");
      iconOpen.classList.remove("hidden");
      iconClose.classList.add("hidden");
      setMobileServicesOpen(false);
      setBodyScrollLocked(false);

      if (restoreFocus) {
        const fallbackTarget = menuButton;
        const target =
          previouslyFocusedElement instanceof HTMLElement && previouslyFocusedElement.offsetParent !== null
            ? previouslyFocusedElement
            : fallbackTarget;
        window.requestAnimationFrame(() => target.focus());
      }
    }

    menuButton.addEventListener("click", () => {
      if (isMenuOpen()) {
        closeMenu({ restoreFocus: false });
      } else {
        openMenu();
      }
    });

    menuOverlay?.addEventListener("click", () => closeMenu({ restoreFocus: true }));

    if (servicesItem && servicesButton && servicesMenu) {
      servicesItem.addEventListener("mouseenter", () => {
        if (window.matchMedia("(min-width: 1024px)").matches) setDesktopServicesOpen(true);
      });

      servicesItem.addEventListener("mouseleave", () => {
        if (window.matchMedia("(min-width: 1024px)").matches) setDesktopServicesOpen(false);
      });

      servicesItem.addEventListener("focusin", () => setDesktopServicesOpen(true));
      servicesItem.addEventListener("focusout", () => {
        window.setTimeout(() => {
          const active = document.activeElement;
          if (active && !servicesItem.contains(active)) {
            setDesktopServicesOpen(false);
          }
        }, 0);
      });

      servicesButton.addEventListener("click", (event) => {
        event.preventDefault();
        const isOpen = servicesButton.getAttribute("aria-expanded") === "true";
        setDesktopServicesOpen(!isOpen);
      });

      servicesMenu.querySelectorAll("[data-services-link]").forEach((link) => {
        link.addEventListener("click", () => setDesktopServicesOpen(false));
      });
    }

    if (mobileServicesToggle) {
      mobileServicesToggle.addEventListener("click", (event) => {
        event.preventDefault();
        event.stopPropagation();
        const expanded = mobileServicesToggle.getAttribute("aria-expanded") === "true";
        setMobileServicesOpen(!expanded);
      });
    }

    if (mobileServicesList) {
      mobileServicesList.addEventListener("click", (event) => event.stopPropagation());
    }

    mobileCloseLinks.forEach((link) => {
      link.addEventListener("click", () => closeMenu());
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        if (isMenuOpen()) {
          event.preventDefault();
          closeMenu({ restoreFocus: true });
        }
        setDesktopServicesOpen(false);
      }
    });

    document.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof Node)) return;

      if (isMenuOpen() && !menuPanel.contains(target) && !menuButton.contains(target) && target !== menuOverlay) {
        closeMenu();
      }

      if (servicesItem && !servicesItem.contains(target)) {
        setDesktopServicesOpen(false);
      }
    });

    const desktopMq = window.matchMedia("(min-width: 1024px)");
    const closeOnDesktop = (event) => {
      if (event.matches && isMenuOpen()) {
        closeMenu();
      }
    };

    const closeOnExitMobile = (event) => {
      if (!event.matches && isMenuOpen()) {
        closeMenu();
      }
    };

    if ("addEventListener" in desktopMq) {
      desktopMq.addEventListener("change", closeOnDesktop);
    } else {
      desktopMq.addListener(closeOnDesktop);
    }

    if ("addEventListener" in mobileViewportQuery) {
      mobileViewportQuery.addEventListener("change", closeOnExitMobile);
    } else {
      mobileViewportQuery.addListener(closeOnExitMobile);
    }

    window.addEventListener("pagehide", () => {
      setBodyScrollLocked(false);
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initNav);
  } else {
    initNav();
  }
</script>
