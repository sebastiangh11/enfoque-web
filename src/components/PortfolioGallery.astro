---
interface Category {
  key: string;
  label: string;
  folder: string;
  seoLabel: string;
  images: string[];
}

interface Props {
  maxItems?: number;
}

const { maxItems = 6 } = Astro.props;

const categories: Category[] = [
  {
    key: "branding-fisico",
    label: "Branding físico",
    folder: "branding-fisico",
    seoLabel: "branding físico corporativo",
    images: [
      "/images/portfolio/branding-fisico/branding-fisico-1.jpeg",
      "/images/portfolio/branding-fisico/branding-fisico-2.jpeg",
      "/images/portfolio/branding-fisico/branding-fisico-3.jpeg",
      "/images/portfolio/branding-fisico/branding-fisico-4.jpeg",
      "/images/portfolio/branding-fisico/branding-fisico-5.jpeg",
    ],
  },
  {
    key: "diseno",
    label: "Diseño",
    folder: "diseno",
    seoLabel: "diseño gráfico para impresión corporativa",
    images: [
      "/images/portfolio/diseno/diseno-1.jpeg",
      "/images/portfolio/diseno/diseno-2.jpeg",
      "/images/portfolio/diseno/diseno-3.jpeg",
      "/images/portfolio/diseno/diseno-4.jpeg",
      "/images/portfolio/diseno/diseno-5.jpeg",
    ],
  },
  {
    key: "expo",
    label: "Expo / stands",
    folder: "expo",
    seoLabel: "stands corporativos para ferias y expos",
    images: [
      "/images/portfolio/expo/stand-1.jpeg",
      "/images/portfolio/expo/stand-2.jpeg",
      "/images/portfolio/expo/stand-3.jpeg",
    ],
  },
  {
    key: "grabado",
    label: "Grabado láser",
    folder: "grabado",
    seoLabel: "grabado láser para personalización corporativa",
    images: [
      "/images/portfolio/grabado/grabado-laser-1.jpeg",
      "/images/portfolio/grabado/grabado-laser-2.jpeg",
      "/images/portfolio/grabado/grabado-laser-3.jpeg",
      "/images/portfolio/grabado/grabado-laser-4.jpeg",
    ],
  },
  {
    key: "papeleria",
    label: "Papelería",
    folder: "papeleria",
    seoLabel: "papelería corporativa e impresión ejecutiva",
    images: [
      "/images/portfolio/papeleria/papeleria-1.jpeg",
      "/images/portfolio/papeleria/papeleria-2.jpeg",
      "/images/portfolio/papeleria/papeleria-3.jpeg",
      "/images/portfolio/papeleria/papeleria-4.jpeg",
      "/images/portfolio/papeleria/papeleria-5.jpeg",
      "/images/portfolio/papeleria/papeleria-6.jpeg",
    ],
  },
  {
    key: "textil",
    label: "Textil",
    folder: "textil",
    seoLabel: "impresión textil corporativa para uniformes y merch",
    images: [
      "/images/portfolio/textil/textil-1.jpeg",
      "/images/portfolio/textil/textil-2.jpeg",
      "/images/portfolio/textil/textil-3.jpeg",
      "/images/portfolio/textil/textil-4.jpeg",
    ],
  },
];

const safeMaxItems = Math.max(1, maxItems);
const initialCategory = categories[0];
const initialImages = initialCategory.images.slice(0, safeMaxItems);
const gridSlots = Array.from({ length: safeMaxItems }, (_, index) => index);
const totalCategoriesLabel = String(categories.length).padStart(2, "0");
---

<div class="relative" data-portfolio-gallery-root>
  <div class="h-px" data-sticky-sentinel aria-hidden="true"></div>

  <div class="mb-3 flex items-center justify-between md:mb-4">
    <p class="text-xs tabular-nums text-text-muted">
      <span data-category-current class="font-semibold text-text-primary">01</span>
      <span class="ml-1">/ {totalCategoriesLabel}</span>
    </p>
    <p class="inline-flex items-center gap-1 text-[11px] font-medium text-text-muted md:hidden" aria-hidden="true">
      <span>Desliza</span>
      <span aria-hidden="true">→</span>
    </p>
    <span class="sr-only" data-category-label aria-live="polite" aria-atomic="true">
      Categoría activa: {initialCategory.label}
    </span>
  </div>

  <div
    class="sticky top-4 z-30 mb-7 rounded-2xl border border-transparent px-1 py-1.5 transition-all duration-200 ease-out md:top-6"
    data-pills-wrapper
    data-sticky="false"
  >
    <div class="pointer-events-none absolute inset-y-0 left-0 z-10 w-8 bg-gradient-to-r from-surface-soft/95 to-transparent md:hidden"></div>
    <div class="pointer-events-none absolute inset-y-0 right-0 z-10 w-8 bg-gradient-to-l from-surface-soft/95 to-transparent md:hidden"></div>

    <div class="no-scrollbar -mx-1 overflow-x-auto px-1 pb-1 scroll-smooth">
      <div class="inline-flex w-max snap-x snap-mandatory items-center gap-2.5 whitespace-nowrap md:flex md:w-full md:flex-wrap md:justify-center md:whitespace-normal">
        {categories.map((category, index) => (
          <button
            type="button"
            class="group min-h-11 shrink-0 snap-start rounded-full border border-border bg-surface px-4 py-2.5 text-sm font-semibold text-text-secondary shadow-sm transition-all duration-200 ease-out hover:-translate-y-0.5 hover:border-border hover:bg-surface-soft hover:text-text-primary hover:shadow-md focus-visible:-translate-y-0.5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2 motion-reduce:transform-none sm:px-5 sm:text-base"
            data-category-button
            data-category-index={index}
            data-active={index === 0 ? "true" : "false"}
            aria-pressed={index === 0 ? "true" : "false"}
            aria-controls="portfolio-grid"
          >
            <span>{category.label}</span>
          </button>
        ))}
      </div>
    </div>
  </div>

  <ul class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-3" id="portfolio-grid" role="list" data-portfolio-grid>
    {gridSlots.map((slotIndex) => {
      const imageSrc = initialImages[slotIndex];
      const isVisible = Boolean(imageSrc);
      return (
        <li data-grid-card hidden={!isVisible} aria-hidden={!isVisible ? "true" : "false"}>
          <button
            type="button"
            class="group block w-full overflow-hidden rounded-2xl border border-border bg-surface text-left shadow-sm transition-all duration-200 ease-out hover:-translate-y-1 hover:border-accent-green/35 hover:shadow-md hover:shadow-black/8 focus-visible:-translate-y-1 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2 motion-reduce:transform-none motion-reduce:transition-none"
            data-grid-trigger
            data-image-index={slotIndex}
          >
            <div class="skeleton-bg relative aspect-[16/10] w-full overflow-hidden bg-surface-soft">
              <img
                src={imageSrc ?? ""}
                alt={`${initialCategory.seoLabel} en México - proyecto ${slotIndex + 1}`}
                loading="lazy"
                decoding="async"
                width="1600"
                height="1000"
                class="h-full w-full object-cover transition-transform duration-300 ease-out group-hover:scale-[1.02] motion-reduce:transform-none motion-reduce:transition-none"
                data-grid-image
              />

              <div class="pointer-events-none absolute inset-x-0 bottom-0 h-1/2 bg-gradient-to-t from-black/40 to-transparent" aria-hidden="true"></div>

              <span
                class="absolute left-3 top-3 inline-flex items-center rounded-full border border-border/80 bg-white/90 px-2.5 py-1 text-[11px] font-semibold text-text-secondary shadow-sm backdrop-blur-sm"
                data-grid-chip
              >
                {initialCategory.label}
              </span>
            </div>
          </button>
        </li>
      );
    })}
  </ul>

  <div
    class="pointer-events-none fixed inset-0 z-50 opacity-0 transition-opacity duration-300"
    data-lightbox
    data-open="false"
    aria-hidden="true"
  >
    <div class="absolute inset-0 bg-black/78" data-modal-backdrop></div>

    <div class="relative flex min-h-full items-center justify-center p-3 md:p-6">
      <div
        class="relative w-full max-w-5xl overflow-hidden rounded-2xl border border-white/15 bg-black/20 shadow-2xl ring-1 ring-white/10"
        data-modal-dialog
        role="dialog"
        aria-modal="true"
        aria-label="Visor de imágenes del portafolio"
      >
        <button
          type="button"
          class="absolute right-3 top-3 z-10 inline-flex min-h-11 min-w-11 items-center justify-center rounded-full border border-white/25 bg-black/45 text-white transition hover:bg-black/65 focus:outline-none focus:ring-2 focus:ring-brand-orange focus:ring-offset-2 focus:ring-offset-black"
          aria-label="Cerrar visor"
          data-modal-close
        >
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 6l12 12M18 6 6 18" />
          </svg>
        </button>

        <div class="relative aspect-[4/3] max-h-[80vh] w-full bg-black">
          <img
            src=""
            alt=""
            loading="eager"
            decoding="async"
            width="1800"
            height="1350"
            class="h-full w-full object-contain"
            data-modal-image
          />

          <div class="pointer-events-none absolute inset-x-0 bottom-0 h-28 bg-gradient-to-t from-black/50 to-transparent" aria-hidden="true"></div>

          <div class="absolute bottom-3 left-1/2 flex -translate-x-1/2 items-center gap-3 rounded-full border border-white/20 bg-black/45 px-3 py-1.5 text-xs font-semibold text-white backdrop-blur-sm md:text-sm">
            <span data-modal-indicator>1 / 1</span>
          </div>

          <button
            type="button"
            class="absolute left-3 top-1/2 inline-flex min-h-11 min-w-11 -translate-y-1/2 items-center justify-center rounded-full border border-white/20 bg-black/45 text-white transition hover:bg-black/65 focus:outline-none focus:ring-2 focus:ring-brand-orange focus:ring-offset-2 focus:ring-offset-black"
            aria-label="Imagen anterior"
            data-modal-prev
          >
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m15 18-6-6 6-6" />
            </svg>
          </button>

          <button
            type="button"
            class="absolute right-3 top-1/2 inline-flex min-h-11 min-w-11 -translate-y-1/2 items-center justify-center rounded-full border border-white/20 bg-black/45 text-white transition hover:bg-black/65 focus:outline-none focus:ring-2 focus:ring-brand-orange focus:ring-offset-2 focus:ring-offset-black"
            aria-label="Siguiente imagen"
            data-modal-next
          >
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m9 6 6 6-6 6" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ categories, safeMaxItems }}>
  const roots = Array.from(document.querySelectorAll("[data-portfolio-gallery-root]"));

  roots.forEach((root) => {
    const buttons = Array.from(root.querySelectorAll("[data-category-button]"));
    const cards = Array.from(root.querySelectorAll("[data-grid-card]"));
    const pillsWrapper = root.querySelector("[data-pills-wrapper]");
    const sentinel = root.querySelector("[data-sticky-sentinel]");
    const categoryCurrent = root.querySelector("[data-category-current]");
    const categoryLabel = root.querySelector("[data-category-label]");

    const lightbox = root.querySelector("[data-lightbox]");
    const modalDialog = root.querySelector("[data-modal-dialog]");
    const modalImage = root.querySelector("[data-modal-image]");
    const modalIndicator = root.querySelector("[data-modal-indicator]");
    const modalPrev = root.querySelector("[data-modal-prev]");
    const modalNext = root.querySelector("[data-modal-next]");
    const modalClose = root.querySelector("[data-modal-close]");
    const modalBackdrop = root.querySelector("[data-modal-backdrop]");

    const state = {
      currentCategoryIndex: 0,
      currentImageIndex: 0,
      activeImages: categories[0].images.slice(0, safeMaxItems),
      lastFocusedCard: null,
      previousBodyOverflow: "",
    };

    const altText = (category, index) => `${category.seoLabel} en México - proyecto ${index + 1}`;
    const isModalOpen = () => lightbox?.getAttribute("data-open") === "true";

    const setModalImage = () => {
      if (!modalImage || !modalIndicator) return;
      const category = categories[state.currentCategoryIndex];
      const src = state.activeImages[state.currentImageIndex];
      if (!src) return;

      modalImage.src = src;
      modalImage.alt = altText(category, state.currentImageIndex);
      modalIndicator.textContent = `${state.currentImageIndex + 1} / ${state.activeImages.length}`;
    };

    const openModal = (index, triggerElement) => {
      if (!lightbox || !modalClose) return;
      if (!state.activeImages[index]) return;

      state.currentImageIndex = index;
      state.lastFocusedCard = triggerElement;
      state.previousBodyOverflow = document.body.style.overflow;
      document.body.style.overflow = "hidden";

      lightbox.setAttribute("data-open", "true");
      lightbox.setAttribute("aria-hidden", "false");
      setModalImage();

      requestAnimationFrame(() => modalClose.focus());
    };

    const closeModal = () => {
      if (!lightbox) return;
      lightbox.setAttribute("data-open", "false");
      lightbox.setAttribute("aria-hidden", "true");
      document.body.style.overflow = state.previousBodyOverflow;

      const lastFocusedCard = state.lastFocusedCard;
      if (lastFocusedCard instanceof HTMLElement) {
        requestAnimationFrame(() => lastFocusedCard.focus());
      }
    };

    const showNext = () => {
      if (!state.activeImages.length) return;
      state.currentImageIndex = (state.currentImageIndex + 1) % state.activeImages.length;
      setModalImage();
    };

    const showPrev = () => {
      if (!state.activeImages.length) return;
      state.currentImageIndex = (state.currentImageIndex - 1 + state.activeImages.length) % state.activeImages.length;
      setModalImage();
    };

    const getFocusableElements = () => {
      if (!modalDialog) return [];
      return Array.from(
        modalDialog.querySelectorAll(
          'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
        )
      ).filter((element) => element instanceof HTMLElement && element.offsetParent !== null);
    };

    const trapFocus = (event) => {
      if (event.key !== "Tab") return;
      const focusable = getFocusableElements();
      if (!focusable.length) return;

      const first = focusable[0];
      const last = focusable[focusable.length - 1];

      if (event.shiftKey && document.activeElement === first) {
        event.preventDefault();
        last.focus();
      } else if (!event.shiftKey && document.activeElement === last) {
        event.preventDefault();
        first.focus();
      }
    };

    const renderCategory = (categoryIndex) => {
      const category = categories[categoryIndex];
      const images = category.images.slice(0, safeMaxItems);
      state.currentCategoryIndex = categoryIndex;
      state.activeImages = images;
      if (categoryCurrent) categoryCurrent.textContent = String(categoryIndex + 1).padStart(2, "0");
      if (categoryLabel) categoryLabel.textContent = `Categoría activa: ${category.label}`;

      buttons.forEach((button, index) => {
        const isActive = index === categoryIndex;
        button.dataset.active = isActive ? "true" : "false";
        button.setAttribute("aria-pressed", isActive ? "true" : "false");
      });

      cards.forEach((card, index) => {
        const src = images[index];
        const image = card.querySelector("[data-grid-image]");
        const chip = card.querySelector("[data-grid-chip]");
        const trigger = card.querySelector("[data-grid-trigger]");

        if (!src || !image || !chip || !trigger) {
          card.hidden = true;
          card.setAttribute("aria-hidden", "true");
          return;
        }

        card.hidden = false;
        card.setAttribute("aria-hidden", "false");
        image.src = src;
        image.alt = altText(category, index);
        chip.textContent = category.label;
        trigger.setAttribute("data-image-index", String(index));
        trigger.setAttribute("aria-label", `Abrir proyecto ${index + 1} de ${category.seoLabel}`);
      });

      if (isModalOpen()) {
        if (state.currentImageIndex > images.length - 1) {
          state.currentImageIndex = 0;
        }
        setModalImage();
      }
    };

    buttons.forEach((button) => {
      button.addEventListener("click", () => {
        const index = Number(button.getAttribute("data-category-index") || "0");
        renderCategory(index);
      });
    });

    root.addEventListener("click", (event) => {
      const trigger = event.target instanceof Element ? event.target.closest("[data-grid-trigger]") : null;
      if (!trigger || !(trigger instanceof HTMLElement)) return;
      const index = Number(trigger.getAttribute("data-image-index") || "0");
      openModal(index, trigger);
    });

    modalPrev?.addEventListener("click", showPrev);
    modalNext?.addEventListener("click", showNext);
    modalClose?.addEventListener("click", closeModal);
    modalBackdrop?.addEventListener("click", closeModal);

    document.addEventListener("keydown", (event) => {
      if (!isModalOpen()) return;

      if (event.key === "Escape") {
        event.preventDefault();
        closeModal();
        return;
      }

      if (event.key === "ArrowRight") {
        event.preventDefault();
        showNext();
        return;
      }

      if (event.key === "ArrowLeft") {
        event.preventDefault();
        showPrev();
        return;
      }

      trapFocus(event);
    });

    if (sentinel && pillsWrapper) {
      const stickyObserver = new IntersectionObserver(
        ([entry]) => {
          const isSticky = !entry.isIntersecting && entry.boundingClientRect.top < 0;
          pillsWrapper.setAttribute("data-sticky", isSticky ? "true" : "false");
          pillsWrapper.classList.toggle("is-stuck", isSticky);
        },
        { threshold: 0 }
      );

      stickyObserver.observe(sentinel);
    }

    renderCategory(0);
  });
</script>

<style>
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }

  [data-category-button][data-active="true"] {
    border-color: color-mix(in srgb, var(--accent-green) 32%, var(--border));
    background: color-mix(in srgb, var(--accent-green) 10%, var(--surface));
    color: color-mix(in srgb, var(--accent-green) 72%, black);
    box-shadow: 0 1px 0 color-mix(in srgb, var(--accent-green) 15%, transparent) inset;
  }

  [data-pills-wrapper][data-sticky="true"],
  [data-pills-wrapper].is-stuck {
    border-color: color-mix(in srgb, var(--border) 72%, transparent);
    background: color-mix(in srgb, var(--surface) 84%, transparent);
    box-shadow: 0 10px 24px -20px color-mix(in srgb, black 45%, transparent);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  [data-lightbox][data-open="true"] {
    pointer-events: auto;
    opacity: 1;
  }

  .skeleton-bg::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(
      110deg,
      color-mix(in srgb, var(--surface-soft) 80%, white) 0%,
      color-mix(in srgb, var(--surface-soft) 60%, white) 45%,
      color-mix(in srgb, var(--surface-soft) 80%, white) 100%
    );
    opacity: 0.45;
    pointer-events: none;
  }

  .skeleton-bg > img {
    position: relative;
    z-index: 1;
  }
</style>
